{% extends "base.html" %}
{% block title %}Admin{% endblock %}
{% block scripts %}{% endblock %}
{% block content %}
<h1>Admin Page</h1>
<h2>Sources table</h2>
<table class="sourceTable" id="myTable">
    <tr>
        <th class="idColumn">ID</th>
        <th>Name</th>
        <th>WMO id</th>
        <th>URL</th>
        <th style="border: none; background-color:white;"></th>
        <th style="border: none; background-color:white;"></th>
    </tr>
    {% for source in data.data %}
    <tr>
        <td class="idColumn">{{source.id}}</td>
        <td>{{source.name}}</td>
        <td>{{source.wmo_id}}</td>
        <td>{{source.url}}</td>
        <td class="editRow" onclick="editSource(this)" title="Edit">
            <svg class="icon" fill="currentColor" height="16" viewBox="0 0 16 16" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
            </svg>
        </td>
        <td class="editRow" onclick="removeSource(this)"
            title="Remove">
            <svg class="icon" fill="currentColorimport React, {useState, useEffect} from "react";" height="16" viewBox="0 0 16 16" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
            </svg>
        </td>
    </tr>
    {% endfor %}
</table>
<button class="submitButton" onclick="editSource()" title="Click to add a new data source" type="button">Add Source +
</button>
<button class="submitButton" onclick="manualIngest()" title="Click to ingest new data from sources" type="button">Do
    Manual Ingest
</button>
<button class="submitButton" onclick="reloadServer()" title="Click to Reload the Webserver" type="button">Reload
    Server
</button>
<!--Popup Window-->

<div class="modal" id="myModal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <form action="" class="test" enctype="multipart/form-data" method="post" name="hi">
            {% csrf_token %}
            <table class="editableTable" id="editSourceTable">
                <tr>
                    <th class="idColumn">ID</th>
                    <th>Name</th>
                    <th>WMO_id</th>
                    <th>URL</th>
                </tr>
                <tr>
                    <td class="idColumn"><input id="new_id" name="id" value="{{source.id}}"></td>
                    <td><input id="new_name" name="name" value="{{source.name}}"></td>
                    <td><input id="new_wmo" name="wmo_id" value="{{source.wmo_id}}"></td>
                    <td><input id="new_url" name="url" value="{{source.url}}"></td>
                </tr>
            </table>
            <button class="submitButton" type="submit">Update</button>
        </form>
    </div>
</div>

<script>
    function removeSource(element) {
    if (confirm("Are you sure you want to delete this entry?")){
        console.log("pressed ok");
        source_id = element.parentElement.cells[0].innerHTML;
        console.log(element.parentElement.cells[0].innerHTML)
        var request = new XMLHttpRequest();
        request.ready
        url = "{% url 'delete_source' %}" ;
        request.open("POST", url) ;
        var CSRF_TOKEN = '{{ csrf_token }}';
        request.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        request.send("id=" + source_id);

    }
}

    function editSource(element=false) {
        var wmo_mapping = {{ data.wmo_dict| safe }};
        if (element != false){
            var wmo_id = element.parentElement.cells[2].innerHTML;
            console.log(wmo_id);
            console.log(wmo_mapping[wmo_id]);
            observation = wmo_mapping[wmo_id];
            document.getElementById("new_wmo").readOnly = true;
            document.getElementById("new_id").value = observation.id;
            document.getElementById("new_name").value = observation.name;
            document.getElementById("new_wmo").value = observation.wmo_id;
            document.getElementById("new_url").value = observation.url;
           }
        else {
            document.getElementById("new_wmo").readOnly = false;
            document.getElementById("new_id").value = "";
            document.getElementById("new_name").value = "";
            document.getElementById("new_wmo").value = "";
            document.getElementById("new_url").value = "";
        }

        openModalPopup("myModal", "close");

    }

    function manualIngest() {
        location.href = '/do_manual_ingest';
        alert('Ingesting data...')
    }
</script>

{% endblock %}